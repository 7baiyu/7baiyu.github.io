---
import { USER_AVATAR, USER_SIDEBAR_SOCIAL_ICONS } from "@config";
import { Icon } from "astro-icon/components";
import { Image } from "astro:assets";
import { getAllPosts, getCategoriesWithPosts, getTagsWithCount } from "@utils/blogUtils";

// 获取所有文章、分类与标签
const allPosts = await getAllPosts();
const categoryMap = getCategoriesWithPosts(allPosts);
const tagMap = getTagsWithCount(allPosts);

// 分类排序（按文章数量降序）
const categoryEntries = Array.from(categoryMap.entries()).sort((a, b) => b[1].length - a[1].length);
const tagEntries = Array.from(tagMap.entries()).sort((a, b) => b[1] - a[1]);

// 分类名中英文映射
const categoryNameMap = {
  Course: "教程",
  Note: "笔记",
  Blog: "博客",
  Tech: "技术",
  Life: "生活",
  Project: "项目",
  Documentation: "文档",
  Review: "评测",
};

// 获取中文显示名
const getCategoryDisplayName = (category: string): string =>
  (categoryNameMap as Record<string, string>)[category] || category;
---

<!-- 用户信息 -->
<div class="card-base p-3 mb-4">
  <a href="/about/" class="group block relative mx-auto mb-3 max-w-[12rem] overflow-hidden rounded-xl active:scale-95">
    <div class="absolute w-full h-full flex items-center justify-center transition group-hover:bg-black/30">
      <Icon name="material-symbols:person-outline" class="text-white text-5xl opacity-0 group-hover:opacity-100 transition" />
    </div>
    <Image src={USER_AVATAR} alt="Profile" width={250} height={250} class="w-full h-full object-cover rounded-xl" />
  </a>

  <div class="text-center">
    <div class="font-bold text-xl mb-1 text-base-content">BaiYu</div>
    <div class="h-1 w-5 bg-primary mx-auto mb-2 rounded-full"></div>
    <div class="font-bold text-transparent bg-gradient-to-r from-pink-400 to-purple-400 bg-clip-text mb-2">
      大雨哗哗下
    </div>

    <!-- 社交图标 -->
    <div class="mt-4 pt-3 border-t border-base-content/20">
      <div class="grid grid-cols-4 gap-2 justify-items-center">
        {USER_SIDEBAR_SOCIAL_ICONS.map((icon) => (
          <a href={icon.href} target="_blank" aria-label={icon.title} class="btn btn-circle btn-ghost">
            <Icon name={icon.svg} class="text-xl" />
          </a>
        ))}
      </div>
    </div>

    <!-- 不蒜子访问统计 -->
    <div class="text-center text-sm text-base-content/50 mt-3 pt-3 border-t border-base-content/20">
      <div class="flex items-center justify-center gap-1">
        <Icon name="material-symbols:visibility-outline" class="text-base" />
        <span>访问量：<span id="busuanzi_value_site_pv">加载中...</span></span>
      </div>
      <div class="flex items-center justify-center gap-1 mt-1">
        <Icon name="material-symbols:person-outline" class="text-base" />
        <span>访客数：<span id="busuanzi_value_site_uv">加载中...</span></span>
      </div>
    </div>
  </div>
</div>

<!-- 分类 -->
<div class="card-base p-3 mb-4">
  <div class="font-bold text-lg text-base-content relative ml-4 mb-2 before:w-1 before:h-4 before:bg-primary before:absolute before:left-[-16px] before:top-[5.5px]">
    分类
  </div>
  {categoryEntries.slice(0, 4).map(([category, posts]) => (
    <a href={`/blog/category/${category}`} class="block hover:pl-3 transition-all">
      <div class="flex justify-between items-center p-2 hover:bg-base-200 rounded-lg">
        <span>{getCategoryDisplayName(category)}</span>
        <span class="text-xs bg-base-200 px-2 py-1 rounded-md">{posts.length}</span>
      </div>
    </a>
  ))}
</div>

<!-- 标签 -->
<div class="card-base p-3">
  <div class="font-bold text-lg text-base-content relative ml-4 mb-2 before:w-1 before:h-4 before:bg-primary before:absolute before:left-[-16px] before:top-[5.5px]">
    标签
  </div>
  <div class="flex flex-wrap gap-2">
    {tagEntries.slice(0, 10).map(([tag]) => (
      <a href={`/blog/tag/${tag}`} class="text-sm border border-secondary rounded-md px-2 py-1 hover:bg-secondary hover:text-white transition-all">
        {tag}
      </a>
    ))}
  </div>
</div>

<!-- 不蒜子脚本（全局） -->
<script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<style>
.card-base {
  @apply bg-base-100 rounded-xl shadow-lg border border-base-200;
}
</style>
