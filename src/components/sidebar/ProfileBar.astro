---
import { USER_AVATAR, USER_SIDEBAR_SOCIAL_ICONS } from "../../config";  
import { Icon } from "astro-icon/components";   
import { Image } from "astro:assets";  
import { getAllPosts, getCategoriesWithPosts, getTagsWithCount } from "@utils/blogUtils";  

// 获取所有博客文章和分类信息  
const allPosts = await getAllPosts();  
const categoryMap = getCategoriesWithPosts(allPosts);  
const categoryEntries = Array.from(categoryMap.entries());  

// 分类排序：按文章数量从高到低  
categoryEntries.sort((a, b) => b[1].length - a[1].length);

// 分类名称映射  
const categoryNameMap = {  
  "Course": "教程",  
  "Anime": "动漫",   
  "TV": "电视剧",  
  "Documentation": "文档",  
  "Examples": "示例",  
  "Tutorial": "教程",  
  "Tech": "技术",  
  "Life": "生活",  
  "Blog": "博客",  
  "Project": "项目",  
  "Note": "笔记",  
  "Review": "评测"  
};  

// 获取标签信息  
const tagMap = getTagsWithCount(allPosts);  
const tagEntries = Array.from(tagMap.entries());  
tagEntries.sort((a, b) => b[1] - a[1]); // 按使用频率排序  

// 获取中文分类名  
const getCategoryDisplayName = (category: string): string => {  
  return (categoryNameMap as Record<string, string>)[category] || category;  
};  
---  

<!-- ========== 用户信息卡 ========== -->
<div class="card-base p-3 mb-4">  
  <!-- 头像 -->
  <a aria-label="Go to About Page" href="/about/" class="group block relative mx-auto mt-1 lg:mx-0 lg:mt-0 mb-3 max-w-[12rem] lg:max-w-none overflow-hidden rounded-xl active:scale-95">  
    <div class="absolute transition pointer-events-none group-hover:bg-black/30 group-active:bg-black/50 w-full h-full z-50 flex items-center justify-center">  
      <Icon name="material-symbols:person-outline" class="transition opacity-0 scale-90 group-hover:scale-100 group-hover:opacity-100 text-white text-5xl" />  
    </div>  
    <div class="mx-auto lg:w-full h-full lg:mt-0 overflow-hidden relative image-wrapper">  
      <div class="loading-bar absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-32 h-1 bg-gray-200 dark:bg-gray-700 z-10 rounded-full overflow-hidden" style="opacity: 0;">  
        <div class="loading-progress h-full w-8 bg-primary animate-pulse rounded-full"></div>  
      </div>  
      <div class="transition absolute inset-0 dark:bg-black/10 bg-opacity-50 pointer-events-none"></div>  
      <Image  
        src={USER_AVATAR}  
        alt="Profile Image of the Author"  
        class="w-full h-full object-cover image-content opacity-0 transition-opacity duration-500"  
        style="object-position: center center; opacity: 1;"  
        width={250}  
        height={250}  
        format="webp"  
        loading="eager"  
        onload="this.style.opacity='1'; this.parentElement.querySelector('.loading-bar').style.opacity='0';"  
      />  
    </div>  
  </a>  

  <!-- 用户信息 -->
  <div class="px-2">  
    <div class="font-bold text-xl text-center mb-1 dark:text-neutral-50 transition">BaiYu</div>  
    <div class="h-1 w-5 bg-primary mx-auto rounded-full mb-2 transition"></div>  
    <div class="text-center mb-2.5 transition font-bold tracking-wide bg-gradient-to-r from-pink-400 to-purple-400 bg-clip-text text-transparent hover:scale-105 hover:from-purple-400 hover:to-pink-400">大雨哗哗下</div>

    <!-- 社交图标 -->
    <div class="mt-4 pt-3 border-t border-base-content/20">  
      <div class="grid grid-cols-4 md:grid-cols-2 lg:grid-cols-4 gap-2 justify-items-center">  
        {USER_SIDEBAR_SOCIAL_ICONS.map((icon) => (  
          <div class="tooltip tooltip-bottom" data-tip={icon.title}>  
            <a tabindex="0" href={icon.href} aria-label={icon.ariaLabel} target="_blank" class="btn btn-circle btn-ghost">  
              <Icon name={icon.svg} class="text-xl" />  
            </a>  
          </div>  
        ))}  
      </div>  
    </div>  

    <!-- ✅ 全站访问量（Busuanzi） -->
    <div class="text-center text-sm text-base-content/50 mt-3 pt-3 border-t border-base-content/20">  
      <div class="flex items-center justify-center gap-1">  
        <Icon name="material-symbols:visibility-outline" class="text-base" />  
        <span>访问量：<span id="busuanzi_value_site_pv">加载中...</span></span>  
      </div>  
      <div class="flex items-center justify-center gap-1 mt-1">  
        <Icon name="lucide:user" class="text-base" />  
        <span>访客数：<span id="busuanzi_value_site_uv">加载中...</span></span>  
      </div>  
    </div>  
  </div>  
</div>  

<!-- ========== 分类列表 ========== -->
<div class="card-base p-3 mb-4">  
  <div class="font-bold transition text-lg text-base-content relative ml-4 mb-2 before:w-1 before:h-4 before:rounded-md before:bg-primary before:absolute before:left-[-16px] before:top-[5.5px]">分类</div>  
  <div id="categories" class="collapse-wrapper px-2 overflow-hidden" style="--collapsedHeight: 7.5rem;">  
    {categoryEntries.slice(0, 3).map(([category, posts]) => (  
      <a href={`/blog/category/${category}`}>  
        <button class="w-full h-10 rounded-lg hover:bg-base-200 active:bg-base-300 transition-all pl-2 hover:pl-3 text-base-content hover:text-primary">  
          <div class="flex items-center justify-between mr-2">  
            <div class="overflow-hidden whitespace-nowrap overflow-ellipsis">{getCategoryDisplayName(category)}</div>  
            <div class="transition px-2 h-7 ml-4 min-w-[2rem] rounded-lg text-sm font-bold bg-base-200 flex items-center justify-center">{posts.length}</div>  
          </div>  
        </button>  
      </a>  
    ))}  
  </div>  
</div>  

<!-- ========== 标签列表 ========== -->
<div class="card-base p-3">  
  <div class="font-bold transition text-lg text-base-content relative ml-4 mb-2 before:w-1 before:h-4 before:rounded-md before:bg-primary before:absolute before:left-[-16px] before:top-[5.5px]">标签</div>  
  <div id="tags" class="collapse-wrapper px-2 overflow-hidden">  
    <div class="flex gap-1 flex-wrap">  
      {tagEntries.slice(0, 10).map(([tag]) => (  
        <a href={`/blog/tag/${tag}`} class="h-6 text-base px-2 rounded-md border border-secondary text-base-content hover:bg-secondary hover:text-secondary-content hover:scale-110 transition-all inline-flex items-center justify-center">{tag}</a>  
      ))}  
    </div>  
  </div>  
</div>  

<style>  
.card-base {  
  @apply bg-base-100 rounded-xl shadow-lg border border-base-200;  
}  
.loading-progress {  
  animation: loading-progress 2s ease-in-out infinite;  
}  
@keyframes loading-progress {  
  0% { transform: translateX(-100%); }  
  50% { transform: translateX(0%); }  
  100% { transform: translateX(100%); }  
}  
</style>
